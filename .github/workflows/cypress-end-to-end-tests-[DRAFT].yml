name: cypress-end-to-end-tests-[DRAFT]
on:
  pull_request:
  push:
    branches: [add-tests-for-tips-example]

jobs:
  install: 
    runs-on: ubuntu-latest
    steps:
      - name: 🔀 Checking out repo
        uses: actions/checkout@v2
        
      - name: 🪨 Setup Node
        uses: actions/setup-node@v1
        with:
          node-version: 16
          
      - name: 🤖 Installing Mephisto
        run: |
          pip install -e .
          pip install detoxify
          pip list -v
          
      - name: 🤐 Zip python packages
        run: 7z a python-packages.zip $HOME/.local/lib/python3.8/site-packages
      
      - name: ☝️ Uploading python packages
        uses: actions/upload-artifact@v3.1.0
        with: 
          name: python-packages
          path: ./python-packages.zip
          
      - name: 📦 Installing & building yarn packages
        run: |
          cd packages/mephisto-task
          yarn install
          yarn build
          cd ../mephisto-worker-experience
          yarn install
          yarn build

      - name: 🤐 Zip .yarn to prepare for uploading
        run: 7z a yarn-packages.zip .yarn/

      - name: ☝️ Uploading yarn packages
        uses: actions/upload-artifact@v3.1.0
        with: 
          name: yarn-packages
          path: ./yarn-packages.zip
          
      - name: 🗑 Removing yarn-packages.zip
        run: |
          ls
          rm yarn-packages.zip
          ls
      
        

  static-react-task:
    runs-on: ubuntu-latest
    needs: install
    steps:
      - name: 🔀 Checking out repo
        uses: actions/checkout@v2
        
      - name: 👇 Downloading yarn packages
        uses: actions/download-artifact@v3
        with:
          name: yarn-packages
         
      - name: 📂 Unzipping yarn-packages.zip in .yarn
        run: |
          mv yarn-packages.zip .yarn/yarn-packages.zip
          cd .yarn
          7z e yarn-packages.zip << EOF 
          A
          EOF
          rm yarn-packages.zip
      
      - name: 🔎 Check is downloaded
        run: |
          ls -a
          cd .yarn
          ls -a
        
      - name: 🐍 Installing python
        uses: actions/setup-python@v2

      - name: 🪨 Setup Node
        uses: actions/setup-node@v1
        with:
          node-version: 16

      #- name: 🤖 Install Mephisto
      #  run: |
      #    pip install -e .
      #    pip install detoxify
      
      - name: 👇 Downloading python packages
        uses: actions/download-artifact@v3
        with:
          name: python-packages
      
      - name: 📂 Unzipping python-packages.zip in .site-packages
        run: |
          mv python-packages.zip ~/home/runner/.local/lib/python3.8/site-packages/python-packages.zip
          cd ~/home/runner/.local/lib/python3.8/site-packages/
          7z e python-packages.zip << EOF 
          A
          EOF
          rm python-packages.zip

      - name: 🖋 Create data directory
        run: |
          cd ~
          mkdir mephisto
          cd mephisto
          mkdir data
          
      - name: 📂 Set the data directory
        run: |
          mephisto config core.main_data_directory ~/mephisto/data

      - name: ⌛️ Running cypress tests
        uses: cypress-io/github-action@v3.1.0
        with:
          install: false
          project: ./examples/static_react_task/webapp
          config-file: ./cypress.config.js
          start: python examples/static_react_task/run_task.py mephisto.task.post_build_script=link_mephisto_task.sh
          wait-on: "http://localhost:3000/?worker_id=x&assignment_id=1"
          command-prefix: yarn dlx
          headless: true

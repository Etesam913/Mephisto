name: cypress-end-to-end-tests-[DRAFT]
on:
  pull_request:
  push:
    branches: [add-tests-for-tips-example]

jobs:
  install: 
    runs-on: ubuntu-latest
    steps:
      - name: 🔀 Checking out repo
        uses: actions/checkout@v2
        
      - name: 🪨 Setup Node
        uses: actions/setup-node@v1
        with:
          node-version: 16
      
      - name: 📦 Installing & building packages
        run: |
          cd packages/mephisto-task
          yarn install
          yarn build
          cd ../mephisto-worker-experience
          yarn install
          yarn build
      - name: 🤐 Zip .yarn to prepare for uploading
        run: zip -r packages.zip ./.yarn/
      - name: ☝️ Uploading yarn packages
        uses: actions/upload-artifact@v3.1.0
        with: 
          name: yarn-packages
          path: ./packages.zip
          
      - name: 🗑 Removing zip
        run: |
          ls
          rm packages.zip
          ls

  static-react-task:
    runs-on: ubuntu-latest
    needs: install
    steps:
      - name: 🔀 Checking out repo
        uses: actions/checkout@v2
        
      - name: 👇 Downloading yarn packages
        uses: actions/download-artifact@v3
        with:
          name: yarn-packages
         
      - name: 📂 Unzipping packages.zip
        run: |
          mv packages.zip packages.gz
          gunzip -d packages.gz
          rm packages.gz
      
      - name: 🔎 Check is downloaded
        run: |
          ls -a
          cd .yarn
          ls -a
        
      - name: 🐍 Installing python
        uses: actions/setup-python@v2

      - name: 🪨 Setup Node
        uses: actions/setup-node@v1
        with:
          node-version: 16

      - name: 🤖 Install Mephisto
        run: |
          pip install -e .
          pip install detoxify

      - name: 🖋 Create data directory
        run: |
          cd ~
          mkdir mephisto
          cd mephisto
          mkdir data
      - name: 📂 Set the data directory
        run: |
          mephisto config core.main_data_directory ~/mephisto/data

      
      
      - name: ⌛️ Running cypress tests
        uses: cypress-io/github-action@v3.1.0
        with:
          install: false
          project: ./examples/static_react_task/webapp
          config-file: ./cypress.config.js
          start: python examples/static_react_task/run_task.py mephisto.task.post_build_script=link_mephisto_task.sh
          wait-on: "http://localhost:3000/?worker_id=x&assignment_id=1"
          command-prefix: yarn dlx
          headless: true
